<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ğŸ” Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Arial;
  direction:rtl;
  background:#f4f6f8;
  padding:20px
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:450px;
  margin:auto
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0
}
button{
  border:none;
  border-radius:6px;
  background:#4A90E2;
  color:#fff;
  cursor:pointer
}
.hidden{display:none}
.row{margin:6px 0}
.green{background:#25D366}
</style>
</head>

<body>

<div class="card" id="loginBox">
  <h3>ğŸ” Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
  <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="card hidden" id="clientBox">
  <h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ <span id="cname"></span> ğŸ‘‹</h3>

  <div class="row">ğŸ“ <span id="cphone"></span></div>
  <div class="row">ğŸ“ <span id="caddress"></span></div>
  <div class="row">ğŸ’° <span id="cprice"></span> Ø¬Ù†ÙŠÙ‡</div>
  <div class="row">ğŸ“… Ù…Ù† <span id="cstart"></span> Ø¥Ù„Ù‰ <span id="cend"></span></div>

  <button class="green" onclick="renew()">ğŸ” ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</button>
  <p id="msg"></p>
</div>

<script>
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT"
});

const db = firebase.firestore();
let currentDocId = null;
let currentClient = null;

function normalizePhone(p){
  p = p.replace(/\s/g,"");
  if(p.startsWith("+20")) p = "0"+p.slice(3);
  if(!p.startsWith("0")) p = "0"+p;
  return p;
}

function login(){
  const p = normalizePhone(phone.value.trim());
  db.collection("clients").where("phone","==",p).get().then(snap=>{
    if(snap.empty){
      alert("âŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„");
      return;
    }
    const doc = snap.docs[0];
    currentDocId = doc.id;
    currentClient = doc.data();

    cname.innerText = currentClient.name;
    cphone.innerText = currentClient.phone;
    caddress.innerText = currentClient.address || "-";
    cprice.innerText = currentClient.price || 0;
    cstart.innerText = currentClient.start || "-";
    cend.innerText = currentClient.end || "-";

    loginBox.classList.add("hidden");
    clientBox.classList.remove("hidden");
  });
}

function renew(){
  const newEnd = new Date();
  newEnd.setFullYear(newEnd.getFullYear()+1);

  db.collection("clients").doc(currentDocId).update({
    end: newEnd.toISOString().slice(0,10),
    lastRenew: new Date()
  }).then(()=>{
    msg.innerText = "âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­";

    window.open(
      `https://wa.me/201150402031?text=ğŸ” ØªØ¬Ø¯ÙŠØ¯ ØªØ¹Ø§Ù‚Ø¯%0AØ§Ù„Ø§Ø³Ù…: ${currentClient.name}%0AØ§Ù„Ù‡Ø§ØªÙ: ${currentClient.phone}`,
      "_blank"
    );

    cend.innerText = newEnd.toISOString().slice(0,10);
  });
}
</script>

</body>
</html>
